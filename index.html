<!doctype html>
<html>
  <head>
    <title>2D gaming using Processing.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Norican"></link>
    <link rel="stylesheet" type="text/css" href="EasyPageComments.css"></link>
    <link rel="stylesheet" type="text/css" href="spriteengine.css"></link>
    <script type="text/javascript" src="processing.js"></script>
    <script type="text/javascript" src="minim.js"></script>
    <script type="text/javascript" src="keytrap.js"></script>
    <!--
      Sketch interfacing javascript
    -->
    <script type="text/javascript"> 
      function setCoordinate(x,y) {
        document.getElementById("x").innerHTML = x|0;
        document.getElementById("y").innerHTML = y|0;
      }
      
      function gameView() {
        pjs.setGameView();
        pjs.externals.canvas.focus();
      }
      
      function designView() {
        pjs.setDesignView();
        pjs.externals.canvas.focus();
      }

      var pjs;
      var monitor;
      function bindSketch() {
        var tmp;
        if(!pjs) {
          tmp = Processing.getInstanceById("mario");
          if(tmp && tmp.bindJavaScript) {
            pjs = tmp;
            pjs.bindJavaScript(this);
          } else { setTimeout(bindSketch, 250); }
        }
        if(pjs && !monitor) {
          tmp = Processing.getInstanceById("monitor");
          if(tmp) {
            monitor = tmp;         
            monitor.setActorCount(pjs.getActorCount());
          } else { setTimeout(bindSketch, 250); }
        }
      }
      
      // monitor framerate
      function recordFramerate(frameRate) { if(monitor) { monitor.addPoint(frameRate); }}
      function addActor() { if(monitor) { monitor.addActor(); }}
      function removeActor() { if(monitor) { monitor.removeActor(); }}
      function resetActorCount() { if(monitor) { monitor.resetActorCount(); }}
   
      
      function toggleMonitor() {
        var mon = monitor.externals.canvas;
        if(mon.style.display !== "block") {
          mon.style.display = "block";
        } else { mon.style.display = "none"; }
      }


      document.addEventListener("DOMContentLoaded",function(){
        var mario = document.getElementById("mario");
        mario.focus();
        bindSketch();
      },false);
    </script>
  
  </head>
  <body>
    <div class="content shaded">
      <headers>
        <h1>～ OMG, Mario! ～</h1>
        <h4>A <a href="http://processingjs.org">Processing(.js)</a> sprite based 2D game engine demonstrator... with Mario.</h4>
      </headers>
      
      <table><tr><td>
        <!--
            The various files have been formatted to indicate
            their hierarchical relationship. As such, a Pickup
            extends Actor, which extends Positionable, which
            extends Drawable. Just so you get a better idea
            of how all the code links up.
        -->
        <canvas id="mario" data-processing-sources="JavaScript.pde

          MarioGame_preloads.pde 
          MarioGame.pde
          drawbackground.pde

          Computer.pde
          ViewBox.pde
          Level.pde
            MarioGame_MarioLevel.pde
              MarioGame_MainLevel.pde
              MarioGame_DarkLevel.pde
          LevelLayer.pde
            MarioGame_MarioLayer.pde
              MarioGame_BackgroundColorLayer.pde
              MarioGame_BackgroundLayer.pde
              MarioGame_MainLevelLayer.pde
              MarioGame_DarkLevelLayer.pde

          Drawable.pde
            Positionable.pde
              Actor.pde
                Player.pde
                  MarioGame_Mario.pde
                Interactor.pde
                  MarioGame_Koopa.pde
                    MarioGame_KoopaFlying.pde
                  MarioGame_BanzaiBill.pde
                  BoundedInteractor.pde
                    MarioGame_SpecialBlock.pde
                      MarioGame_CoinBlock.pde
                        MarioGame_CoinBlockBoo.pde
                      MarioGame_MushroomBlock.pde
                      MarioGame_FireFlowerBlock.pde
                    MarioGame_PassThroughBlock.pde
                Pickup.pde
                  MarioGame_Pickups.pde
              Boundary.pde
                MarioGame_PipeBoundary.pde
              Trigger.pde
                MarioGame_Triggers.pde
              Sprite.pde
                Decal.pde
                  MarioGame_Decals.pde
              TilingSprite.pde

          ShapePrimitives.pde
          SpriteMapHandler.pde
          SpritePath.pde
          SpritePathChunker.pde
          SoundManager.pde
          State.pde
          Tracking.pde" style="border: 1px solid black;" tabindex="1"></canvas>
        <p class="smaller center">Current Mario coordinates: <span id="x"></span>/<span id="y"></span>
           - 
           <span> [<a href="javascript:gameView()">game view</a>] </span>
           -
           <span> [<a href="javascript:designView()">design view</a>] </span>
           -
           <span> [<a href="javascript:toggleMonitor()">toggle Statistics</a>] </span>
        </p>

        <canvas id="monitor" data-processing-sources="tools/monitor/monitor.pde"></canvas>

      </td><td>     
        <div style="border: 1px solid black; background-color: rgba(255,255,100,0.2); margin-top: 1em;">
          <h1>Game engine features</h1>
          <ul class="smaller">
            <li>Designed for 2D sprite based games</li>
            <li>Physics-based movement</li>
            <li>Persistence-based key input rather than tracking keydown and keyup events.</li>
            <li>Regular and tiling sprites (demo: tiled background, ground)</li>
            <li>Multiple layers (demo: background, actor layer, foreground)</li>
            <li>Viewbox-based drawing</li>
            <li>Visual decals (demo: points when hitting enemies)</li>
            <li>State based actors (demo: mario constantly changes states)</li>
            <li>State transition events (demo: ghost block)</li>
            <li>Unidirectionally passable boundaries</li>
            <li>Actors-with-boundaries (demo: ghost block, passthrough blocks)</li>
            <li>Different levels of interaction (demo: players interact with everything, NPCs don't with NPCs or pickups, ghost is not hindered by boundaries, etc)</li>
            <li>Moving "on rails" (demo: flying koopas)</li>
            <li>Interaction triggers (demo: mushrooms, blocks, finish line)</li>
            <li>Event trigger regions (demo: type "7" to see them in-game)</li>
            <li>Actor tracking (demo: ghost coin block)</li>
            <li>Persistent and expiring objects (demo: mushrooms expire if they go too far off-screen, Koopas do not)</li>
            <li>Support for mp3 and ogg audio (demo: press <img style="position:relative; top:2px;" src="graphics/unmute.gif" width=12 height=12> in the upper-right corner!)</li>
            <li>Supported in all HTML5 browsers, including IE9!</li>
            <!--
              <li>Small! This demo is 77KB for the library, 46KB for the game, and 23KB in graphics. The only thing making it big is the audio.</li>
            -->
          </ul>
        </div>
      </td></tr></table>

      <table id="controls"><tr><td>
        <p><strong>Mario controls:</strong> 'W', 'A', 'S' and 'D' keys, and keys/mouse buttons for jump ('Q' / left click) and spin jump or shoot ('E' / right click). Can you find the flower?</p>
      </td><td>
        <p class="smaller"><strong>debug controls:</strong> [1] toggles background, [2] toggles boundaries, [3] toggles pickups, [4] toggles NPCs, [5] toggles Mario, [6] toggles the foreground, [7] toggle trigger regions, [8] toggles actor bounding boxes.</p>
      </td></tr></table>

      <hr>

      <p><strong>TODO</strong>: loading all of this from a game script, made in a web-based level editor, so that you can build games without having to actually program!
         That said, you are highly encouraged to look at <a href="spriteengine.pde">the non-library source code</a> for this demonstrator!<p>

      <hr>

      <p>A work in progress by me, <a href="http://pomax.nihongoresources.com">Pomax</a>.
         You might know me from <a href="http://processingjs.org">Processing.js</a>,
         <a href="http://github.com/Pomax/Font.js">Font.js</a>, or perhaps even something
         else (Like my <a href="http://processingjs.nihongoresources.com/bezierinfo">primer
         on Bezier curves</a>, writeup on <a href="http://processingjs.nihongoresources.com/the_smallest_font/">the
         smallest web-legal TTF</a>, or <a href="http://redesign.nihongoresources.com">nihongoresources</a>).
         If you don"t know me: I do things these kind of things. Then I explain them to
         people. If you wish to reach me, I'm on IRC (irc.mozilla.org and irc.freenode.net
         amongst others) as Pomax, as well as on twitter, as <a href="https://twitter.com/TheRealPomax">TheRealPomax</a>,
         although of course you can also just leave a comment in the comment section!
      </p>

      <hr>
       
      <h1>Leave a comment, I love comments!</h1>
      <div id="pagecomments"></div>
      <div id="pagecommentform"></div>
       
      <!-- -->
      <script type="text/javascript" src="EasyPageComments.js"></script>
      <script type="text/javascript">
        function showEasyPageComments(data) {
          document.getElementById("pagecomments").innerHTML = data+"<hr>"; }

        function showEasyPageCommentForm(data) {
          document.getElementById("pagecommentform").innerHTML = data; }

        function addEasyPageComments() {
          EasyPageComments.createCommentsList("EasyPageComments");
          EasyPageComments.createCommentForm("EasyPageComments"); }

        document.addEventListener("DOMContentLoaded", addEasyPageComments, false)
      </script>
      <!-- -->
    </div>
  </body>

  <script type="text/javascript">
    KeyTrap.trap(document.getElementById('mario'),[37,38,39,40]);
  </script>

  <!--
    code preprocessor to wrap all "new" statements
    to find out whether there's constant object
    creation. Hooks into PJS in loadBlocks
  -->
  <script type="text/javascript">
    function preProcessProcessingCode(code) {
      var lines = code.split("\n"), l=0, last = lines.length;
      var search = "(([a-zA-Z\d]+)\\s*=\\s*new\\s+([A-Z][A-Za-z\\d]+).+;)";
      var replace;
    
      for(l=0; l<last; l++) {
           replace = "$1\nComputer.create(\"$2\",\"$3\", "+l+");";
        lines[l] = lines[l].replace(new RegExp(search,'gm'), replace);
      }
      
      var cnt = document.createElement("textarea");
      cnt.style.display = "block";
      cnt.style.height = "900px";
      cnt.style.width = "1024px";
      
      cnt.innerHTML = lines.join("\n");
      document.body.appendChild(cnt);
      return lines;
    }
    
    PJScreates = {};

    function showPJSstats() {
      var s = "";
      for(type in PJScreates) {
        s += type + ": " + PJScreates[type].length + "\n";
      }
      window.console.log(s);
    }
    
    var debugPJS = (window.location.toString().indexOf("debug=true") > -1);
    
    var P3Dmode = (window.location.toString().indexOf("3d=true") > -1);
  </script>
</html>